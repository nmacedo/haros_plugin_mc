%YAML 1.1
---
project: agrob
packages:
    - agrobv16_supervisor
    - Agrob_path
configurations:
    startup:
        launch:
            - agrobv16_supervisor/launch/startup.launch
    startup_hints:
        launch:
            - agrobv16_supervisor/launch/startup.launch
        hints:
            /agrobv16SUPERVISOR:
                subscribe:
                    /kinect2/qhd/image_color_rect: sensor_msgs/Image
                    /kinect2/qhd/image_depth_rect: sensor_msgs/Image
                    /kinect2/qhd/camera_info: sensor_msgs/CameraInfo
            /supervisorGUI1:
                subscribe:
                    /diagnostics: diagnostic_msgs/DiagnosticArray
                    /agrobv16/states: std_msgs/String
                    /agrobv16/current_state: std_msgs/Int16MultiArray
                    /safer_zone/image/compressed: sensor_msgs/CompressedImage
            /ekf_localization:
                subscribe:
                    husky_velocity_controller/odom: nav_msgs/Odometry
            /Agrobv16_twist_mux:
                subscribe:
                    joy_teleop/cmd_vel: geometry_msgs/Twist
                    twist_marker_server/cmd_vel: geometry_msgs/Twist
                    move_base/cmd_vel: geometry_msgs/Twist
                    cmd_vel: geometry_msgs/Twist
                    supervisor/cmd_vel: geometry_msgs/Twist
                    
rules:
    no_conditional_comm:
        name: No Conditional Communications
        description: "Advertise, Subscribe, AdvertiseService and ServiceClient
                      should not be called under control flow structures."
        tags:
            - code-standards
            - custom
            - ros-comm
        query: "nodes/advertise[self.control_depth > 0] |
                nodes/subscribe[self.control_depth > 0] |
                nodes/service[self.control_depth > 0] |
                nodes/client[self.control_depth > 0]"
    type_check_topics:
        name: Message Types Must Match
        description: Message types at both ends of a topic must match.
        tags:
            - code-standards
            - custom
            - ros-comm
            - type-checking
        query: "for p in <configs/nodes/publishers>,
                    s in <configs/nodes/subscribers>
                where p.topic_name == s.topic_name and p.type != s.type
                return p, s"
    infinite_queues:
        name: Avoid Infinite Topic Queues
        description: Topic message queues should not use a queue size of zero.
        tags:
            - code-standards
            - ros
            - ros-comm
        query: "nodes/advertise[self.queue_size == 0] |
                nodes/subscribe[self.queue_size == 0]"
    advertise_queue_1:
        name: Publishers With a Queue of Size 1
        description: Publishers with a queue of size 1 can possibly lose messages.
        tags:
            - code-standards
            - custom
            - ros-comm
        query: "nodes/advertise[self.queue_size == 1]"
    subscriber_queue_enough:
        name: Sufficiently Big Subscriber Queues
        description: "Subscribers must have a queue with a size that is big enough
                        for the expected amount of publishers on the topic."
        tags:
            - code-standards
            - custom
            - ros-comm
        query: "for s in <configs/nodes/subscribers[self.queue_size != None
                                                    and self.queue_size > 0]>
                let p = <configs/nodes/publishers[self.topic_name == s.topic_name
                                                  and self.queue_size != None]>
                where some a in <p> satisfies (a.queue_size == 0)
                                    or (s.queue_size < sum(<p/queue_size>)
                                    or s.queue_size <= len(p))
                return s"
    disconnected_similar_topics:
        name: No Disconnected Similar Topics
        description: "If two topics are similar and disconnected, it is possible
                        that there is a missing remap."
        tags:
            - code-standards
            - custom
            - ros-comm
        query: "for c in <configs>
                let pairs = {
                    for pub in <c/nodes/publishers[self.topic.is_disconnected]>,
                        sub in <c/nodes/subscribers[self.topic.is_disconnected]>
                    where pub.type == sub.type and
                        (pub.topic.id.endswith(sub.topic.name)
                        or sub.topic.id.endswith(pub.topic.name)
                        or pub.rosname.full == sub.rosname.full
                        or pub.rosname.full.endswith(sub.rosname.own)
                        or sub.rosname.full.endswith(pub.rosname.own)
                        or pub.rosname.given == sub.rosname.given)
                    return 'pub':pub, 'sub':sub
                }
                where len(pairs) > 0
                return c, pairs"
    connected_to_base:
        name: Every Node Publishes to Base
        description: Every node is transitively connected to Kobuki mobile base.
        tags:
            - code-standards
            - custom
            - agrob
            - ros-comm
        query: "for n in <configs/nodes>
                where not 'husky_node' in <n/rt_outlinks/name>
                return n"

